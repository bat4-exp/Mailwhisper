<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mailwhisper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .waveform {
            height: 60px;
            background: linear-gradient(90deg, #3b82f6, #9333ea);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .waveform::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.1) 2px,
                transparent 2px,
                transparent 4px
            );
            animation: wave 1s linear infinite;
        }
        @keyframes wave {
            from { transform: translateX(-4px); }
            to { transform: translateX(0); }
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Voice to Business Email</h1>
            <p class="text-gray-600 max-w-2xl mx-auto">Record your thoughts and instantly transform them into professional business emails in multiple languages.</p>
        </header>
        <div class="flex flex-col gap-6">
            <div class="flex-1">
                <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
                    <div class="p-6">
                        <div class="flex flex-wrap gap-4 mb-6">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                                <select id="language-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="nl">Dutch</option>
                                    <option value="ja">Japanese</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ru">Russian</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Header</label>
                                <input type="text" id="email-header" placeholder="Optional header text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Footer</label>
                                <input type="text" id="email-footer" placeholder="Optional footer text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jargon/Technical Terms (comma separated)</label>
                            <input type="text" id="jargon-terms" placeholder="e.g. API, SaaS, ROI, KPI" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">AI Creativity</label>
                            <div class="flex items-center gap-4">
                                <span class="text-sm text-gray-500">Precise</span>
                                <input type="range" id="creativity-slider" min="0" max="100" value="50" class="w-full slider-thumb">
                                <span class="text-sm text-gray-500">Creative</span>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 mb-6">
                            <button id="record-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                                <i class="fas fa-microphone"></i> Start Recording
                            </button>
                            <button id="pause-btn" disabled class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button id="stop-btn" disabled class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                                <i class="fas fa-stop"></i> Stop & Convert
                            </button>
                        </div>
                        <div id="recording-indicator" class="hidden mb-6">
                            <div class="waveform"></div>
                            <p class="text-sm text-gray-500 mt-2 flex items-center gap-2">
                                <span class="h-3 w-3 bg-red-500 rounded-full animate-pulse"></span>
                                <span id="recording-time">00:00</span>
                            </p>
                        </div>
                        <div class="mb-2 flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Transcription / Email</label>
                            <button id="copy-btn" class="text-sm text-blue-600 hover:text-blue-800 hidden">
                                <i class="fas fa-copy mr-1"></i> Copy to Clipboard
                            </button>
                        </div>
                        <div class="relative">
                            <textarea id="transcription-text" rows="12" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Your transcribed email will appear here"></textarea>
                            <div id="processing-indicator" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden">
                                <div class="text-center">
                                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                    <p class="text-gray-700">Converting to business email...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
    // Set your Cloudflare Worker URL here:
    const WORKER_URL = "https://mailwhisper.bram-admiraal.workers.dev";

    // DOM Elements
    const recordBtn = document.getElementById('record-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const copyBtn = document.getElementById('copy-btn');
    const transcriptionText = document.getElementById('transcription-text');
    const recordingIndicator = document.getElementById('recording-indicator');
    const recordingTime = document.getElementById('recording-time');
    const processingIndicator = document.getElementById('processing-indicator');
    const languageSelect = document.getElementById('language-select');
    const emailHeader = document.getElementById('email-header');
    const emailFooter = document.getElementById('email-footer');
    const jargonTerms = document.getElementById('jargon-terms');
    const creativitySlider = document.getElementById('creativity-slider');

    // Recording state
    let mediaRecorder;
    let audioChunks = [];
    let recordingStartTime;
    let recordingTimer;
    let isPaused = false;
    let pauseStartTime;
    let totalPausedTime = 0;

    recordBtn.addEventListener('click', startRecording);
    pauseBtn.addEventListener('click', togglePause);
    stopBtn.addEventListener('click', stopRecording);
    copyBtn.addEventListener('click', copyToClipboard);

    function startRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    sendAudioToWorker(audioBlob);
                };
                mediaRecorder.start(100);
                recordingStartTime = new Date();
                totalPausedTime = 0;
                startRecordingTimer();
                recordBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                recordingIndicator.classList.remove('hidden');
                recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            })
            .catch(error => {
                alert('Could not access microphone. Please check permissions.');
            });
    }

    function togglePause() {
        if (!mediaRecorder) return;
        if (isPaused) {
            mediaRecorder.resume();
            totalPausedTime += (new Date() - pauseStartTime);
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            pauseBtn.classList.remove('bg-gray-500');
            pauseBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            startRecordingTimer();
        } else {
            mediaRecorder.pause();
            pauseStartTime = new Date();
            clearInterval(recordingTimer);
            pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
            pauseBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            pauseBtn.classList.add('bg-gray-500');
        }
        isPaused = !isPaused;
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            clearInterval(recordingTimer);
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            recordBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            recordingIndicator.classList.add('hidden');
            recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        }
    }

    function startRecordingTimer() {
        clearInterval(recordingTimer);
        recordingTimer = setInterval(() => {
            const elapsed = new Date() - recordingStartTime - totalPausedTime;
            const minutes = Math.floor(elapsed / 60000).toString().padStart(2, '0');
            const seconds = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
            recordingTime.textContent = `${minutes}:${seconds}`;
        }, 1000);
    }

    // Send to Cloudflare Worker, which should:
    // 1. Use Deepgram API for transcription
    // 2. Use Deepseek API for business email transformation
    // 3. Return the generated email as plain text
    function sendAudioToWorker(audioBlob) {
        processingIndicator.classList.remove('hidden');
        transcriptionText.value = '';
        copyBtn.classList.add('hidden');
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
        formData.append('language', languageSelect.value);
        formData.append('header', emailHeader.value.trim());
        formData.append('footer', emailFooter.value.trim());
        formData.append('jargon', jargonTerms.value.trim());
        formData.append('creativity', creativitySlider.value);

        fetch(WORKER_URL, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('API error');
            return response.text();
        })
        .then(emailText => {
            transcriptionText.value = emailText;
            copyBtn.classList.remove('hidden');
        })
        .catch(err => {
            transcriptionText.value = 'Error: Could not process audio.';
        })
        .finally(() => {
            processingIndicator.classList.add('hidden');
        });
    }

    function copyToClipboard() {
        transcriptionText.select();
        document.execCommand('copy');
        // Visual feedback
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
        }, 2000);
    }
    </script>
</body>
</html>
